# SFDX Deployer

## Purpose

You have a dev hub, and an sfdx repo.  You'd like to let people spin up scratch orgs based on the repo, and these people might not feel like using a terminal, cloning the repo, loggin in to a dev hub, and executing sfdx commands.
* because they might not be developers (think admins, or even end users in a training scenario)
* because they might not be Salesforce developers (say you built an app and give your designer/CSS person github access to "make it cool")
* because you might have dev hub access and you don't want to give it to them
* because you want to let people test the app quickly
* because (like me) you're using it for workshops and demos
---

## Connected app setup
Create a connected app for JWT auth, with certificates, per the SFDX setup guide.


https://developer.salesforce.com/docs/atlas.en-us.sfdx_dev.meta/sfdx_dev/sfdx_dev_auth_jwt_flow.htm


---

## Environment variables

### Required
* `HUB_USERNAME` the username from your dev hub
* `CONSUMERKEY` from your connected app

### Cloud only
* `CLOUDAMQP_URL` starts with amqp://, generated by installing the amqp add-on

### Plus one of the following, depending on where you're running
* `JWTKEY` use only in heroku cloud.  Cut/paste your server.key, including the ---- lines
* `LOCAL_ONLY_KEY_PATH` don't use this in the cloud.  Put it in your local .env file, and it needs to be an absolute path

### optional
* `UA_ID` for google analytics measurement protocol
* `GITHUB_USERNAME_WHITELIST` lets you whitelist usernames.  It's a comma-separated list.  Ex: `mshanemc,andrew,bebraw`
* `GITHUB_REPO_WHITELIST` lets you whitelist username/repo combinations.  It's a comma-separated list. Ex: `mshanemc/DF17integrationWorkshops,torvalds/linux`

What's whitelisting do?  Normally, this app will parse your orgInit.sh and throw an error if you're doing any funny business.  BUT if you're on the whitelist, the app owner trusts you and you can do things with bash metacharacters (think &&, |, >) and execute non-sfdx commands  (grep, rm, whatever!) etc.  BE CAREFUL!

Here's a heroku button so you can have your own instance of the Deployer

[![Deploy](https://www.herokucdn.com/deploy/button.svg)](https://heroku.com/deploy?template=https%3A%2F%2Fgithub.com%2Fmjacquet%2Fdeploy-to-sfdx)

---
## Heroku setup

The button will start this on free hobby dynos.  For real life, I'd recommend a pair of web 1x and a pair of workers at 1x.

If you're going to be doing a lot of users (imagine a workshop where lots of people are pushing the button at the same time) you can scale out more workers so the people last in line don't have to wait so long.  Otherwise, it'll spin while the workers are busy processing the deploy request queue.

---

## Architectural overview

Nodejs, express for the web server.
When the web server receives a request, it creates a unique deployID (user-repo-timestamp) and a message on the deploy queue (using rabbitMQ)
The server redirects the user to a web page which subscribes to a websocket

When a worker starts up, it auths to a devhub via its environment variables.
Then it listens to the deploy queue and executes jobs
* clone the repo into local filestorage
* execute the orgInit.sh script, or the default create/push/open flow if there isn't one
* drop the output results of these steps into a broadcast exchange
* delete the local folder and send the ALLDONE message

All the web servers are subscribed to the broadcast exchange.  When they receive messages, they look at the deployID and send the messages down to the matching client.

## Local Setup (Mac...others, who knows?)

You'll need to have a local filesystem structure that kinda replicates what we're doing on the heroku dyno.
```
mkdir tmp
```

NOTE: This will overwrite your dev hub default.  If you go back to doing other sfdx local work, be sure to re-auth to your hub.

Then put your JWT server.key file from the connected app in the /app/tmp folder.  (In heroku cloud, this'll load from the environment variable **JWTKEY** but heroku local doesn't load multiline variables easily, so that's why the manual placement of the key file is needed).

You'll also need rabbitmq running locally (handled on heroku via cloudamqp)

https://www.rabbitmq.com/install-homebrew.html

which you'll start up with
`/usr/local/sbin/rabbitmq-server` (accept any popups to allow comms)

then start this app with
`heroku local`

---
## Debugging on [non-local] Heroku
if **hosted-scratch-qa** is the name of your app

`heroku logs --tail -a hosted-scratch-qa` will give you the logs.  This app uses console.log pretty heavily.

`heroku ps:exec -a hosted-scratch-qa --dyno=worker.1` lets you ssh into the dyno of your choice and take a look around, clean stuff up, etc.

---
## Setting up a repo (optional)

So you need a target repo to deploy (see examples below).  If your repo is simple, the tool will do the default behavior (create, push source, open).

But with an orgInit.sh file, you can list out all your sfdx commands and they'll be executed by the deployer.  Remember, no bash metacharacters and only sfdx commands are allowed (We can't let anyone run any arbitrary command on our servers...security, yo!)

That lets you create records, assign permsets, create users, install packages, run tests, generate passwords, and do anything you can do with an SFDX command

---
## Launcher URLs

There's not anything at / on the server.  Don't worry.  The only page you care about is `/launch` which takes 1 parameter `template`

So your path should be `https://whatever.herokuapp.com/launch?template=https://github.com/username/reponame`

Also handles branches on github, like `https://whatever.herokuapp.com/launch?template=https://github.com/username/reponame/tree/somebranch`

---
## Example Repos with orgInit.sh scripts

https://github.com/mshanemc/DF17integrationWorkshops [![Deploy](https://raw.githubusercontent.com/mshanemc/deploy-to-sfdx/master/assets/sfdx_it_now.png)](https://hosted-scratch.herokuapp.com/launch?template=https://github.com/mshanemc/DF17integrationWorkshops)


https://github.com/mshanemc/community-apps-workshop-df17 [![Deploy](https://raw.githubusercontent.com/mshanemc/deploy-to-sfdx/master/assets/sfdx_it_now.png)](https://hosted-scratch.herokuapp.com/launch?template=https://github.com/mshanemc/community-apps-workshop-df17)

https://github.com/mshanemc/process-automation-workshop-df17 [![Deploy](https://raw.githubusercontent.com/mshanemc/deploy-to-sfdx/master/assets/sfdx_it_now.png)](https://hosted-scratch.herokuapp.com/launch?template=https://github.com/mshanemc/process-automation-workshop-df17)

https://github.com/mshanemc/df17-community-content-workshop [![Deploy](https://raw.githubusercontent.com/mshanemc/deploy-to-sfdx/master/assets/sfdx_it_now.png)](https://hosted-scratch.herokuapp.com/launch?template=https://github.com/mshanemc/df17-community-content-workshop)

https://github.com/mshanemc/df17AppBuilding [![Deploy](https://raw.githubusercontent.com/mshanemc/deploy-to-sfdx/master/assets/sfdx_it_now.png)](https://hosted-scratch.herokuapp.com/launch?template=https://github.com/mshanemc/df17AppBuilding)
